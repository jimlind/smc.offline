<!doctype html>
<html>
<head>
    <script type="text/javascript" src="js/zepto.min.js"></script>
    <script type="text/javascript">
	var $db = openDatabase("database", "1.0", "Local StashMyComics Data", 5*1024*1024);
	var $im = openDatabase("imgdatabase", "1.0", "Local StashMyComics Images", 45*1024*1024);
	
	$(document).ready(function(){
	    
	    $("#showStashes").bind("click", function(event){
		$("#stashes").show();
		$("#series").hide();
		$("#issues").hide();
	    });
	    
	    $("#showSeries").bind("click", function(event){
		$("#stashes").hide();
		$("#series").show();
		$("#issues").hide();
	    });
	    
	    $("#showIssues").bind("click", function(event){
		$("#stashes").hide();
		$("#series").hide();
		$("#issues").show();
	    });
	    
	    var $stashList = $("#stashList");
	    $db.transaction(function ($tx) {
		var $query = "SELECT stashID, title FROM stash";
		$tx.executeSql($query, [], function ($tx, $results) {
		    var $length = $results.rows.length;
		    for(var $i = 0; $i < $length; $i++) {
			var $item = $results.rows.item($i);
			var $li = $('<li />').html($item.title).attr("stashID", $item.stashID);
			$stashList.append($li);
		    }
		});
	    });
	    $("#showStashes").trigger("click");
	    
	    $("#stashList li").live("click", function(event){
		var $id = $(event.target).attr("stashID");
		var $seriesList = $("#seriesList");
		$seriesList.children().remove();
	        $db.transaction(function ($tx) {
		    var $query = "SELECT seriesID, smcSeriesID, title, publisher FROM series WHERE stashID = " + $id;
		    $tx.executeSql($query, [], function ($tx, $results) {
			var $length = $results.rows.length;
		        for(var $i = 0; $i < $length; $i++) {
			    var $item = $results.rows.item($i);
			    var $text = $item.title + " " + $item.publisher;
			    var $li = $('<li />').html($text).attr("seriesID", $item.seriesID).attr("smcID", $item.smcSeriesID);
			    $seriesList.append($li);
			}
		    });
		});
		$("#showSeries").trigger("click");
	    });
	    
	    $("#seriesList li").live("click", function(event){
		var $id = $(event.target).attr("seriesID");
		var $smc = $(event.target).attr("smcID");
		var $issueList = $("#issueList");
		var $h1 = $("#issues").find("h1");
		var $img = $("#issues").find("img");
		$issueList.children().remove();
	        $db.transaction(function ($tx) {
		    var $query = "SELECT * FROM series, issue WHERE series.seriesID = issue.seriesID AND series.seriesID = ?";
		    $tx.executeSql($query, [$id], function ($tx, $results) {
			var $length = $results.rows.length;
			if ($length == 0) {
			    $h1.html("No Issues Found");
			    return false;
			}
			$h1.html("Issues of " + $results.rows.item(0).title);
			var $length = $results.rows.length;
			for(var $i = 0; $i < $length; $i++) {
			    var $item = $results.rows.item($i);
			    var $text = $item.issueNumber + " :: " + $item.published;
			    if ($item.info != "") {
				$text += " :: " + $item.info;
			    }
			    var $li = $('<li />').html($text);
			    $issueList.append($li);
			}
		    });
		});
		$im.transaction(function ($tx) {
		    var $query = "SELECT * FROM image WHERE smcSeriesID = ?";
		    $tx.executeSql($query, [$smc], function ($tx, $results) {
			$img.attr("src", $results.rows.item(0).data);
		    });
		});
		$("#showIssues").trigger("click");
	    });
	});
    </script>
    
    <style type="text/css">
	body {
	    background:#990033;
	}
	li { cursor:pointer;
	    text-decoration:underline;
	}
	li:hover {
	    text-decoration:none;
	}
	.revert {
	    cursor:pointer;
	    text-decoration:underline;
	}
	.revert:hover {
	    text-decoration:none;
	}
	#issueList li {
	    text-decoration:none;
	    cursor:default;
	}
    </style>
</head>
<body>
    <div id="stashes" style="display:none;">
	<h1>Stashes</h1>
	<ul id="stashList"></ul>
    </div>
 
    <div id="series" style="display:none;">
	<h1>Series</h1>
	<p id="showStashes" class="revert">Show Stashes</p>
	<ul id="seriesList"></ul>
    </div>
    
    <div id="issues" style="display:none;">
	<h1>Issues</h1>
	<p id="showSeries" class="revert">Show Series</p>
	<img src=""/>
	<ul id="issueList"></ul>
    </div>
    
    <div id="showIssues" style="display:none" />
</body>